services:
  # PostgreSQL Database for Control Plane
  kong-database-cp:
    image: postgres:13
    container_name: kong-database-cp
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-kong}
      POSTGRES_DB: ${POSTGRES_DB:-kong}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-kongpass}
    ports:
      - "5432:5432"
    volumes:
      - kong-data-cp:/var/lib/postgresql/data
    networks:
      - kong-net-hybrid
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "kong"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kong Database Migration
  kong-migration-cp:
    image: kong:3.4
    container_name: kong-migration-cp
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: ${KONG_DATABASE:-postgres}
      KONG_PG_HOST: ${KONG_PG_HOST:-kong-database-cp}
      KONG_PG_USER: ${KONG_PG_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:-kongpass}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong}
    networks:
      - kong-net-hybrid
    depends_on:
      kong-database-cp:
        condition: service_healthy
    restart: on-failure

  # Kong Control Plane
  kong-cp:
    image: kong:3.4
    container_name: kong-cp
    environment:
      # Role Configuration
      KONG_ROLE: control_plane
      KONG_CLUSTER_CERT: /certs/cluster.crt
      KONG_CLUSTER_CERT_KEY: /certs/cluster.key
      
      # Database Configuration
      KONG_DATABASE: ${KONG_DATABASE:-postgres}
      KONG_PG_HOST: ${KONG_PG_HOST:-kong-database-cp}
      KONG_PG_USER: ${KONG_PG_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:-kongpass}
      KONG_PG_DATABASE: ${KONG_PG_DATABASE:-kong}
      
      # Cluster Configuration
      KONG_CLUSTER_LISTEN: 0.0.0.0:8005
      KONG_CLUSTER_TELEMETRY_LISTEN: 0.0.0.0:8006
      
      # Admin API Configuration
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      KONG_ADMIN_GUI_LISTEN: 0.0.0.0:8002
      
      # Logging
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
    ports:
      - "8001:8001"  # Admin API
      - "8002:8002"  # Admin GUI
      - "8005:8005"  # Cluster
      - "8006:8006"  # Cluster Telemetry
    volumes:
      - kong-cluster-certs:/certs:ro
    networks:
      - kong-net-hybrid
    depends_on:
      kong-database-cp:
        condition: service_healthy
      kong-migration-cp:
        condition: service_completed_successfully
      kong-cert-generator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: on-failure

  # Kong Data Plane 1
  kong-dp-1:
    image: kong:3.4
    container_name: kong-dp-1
    environment:
      # Role Configuration
      KONG_ROLE: data_plane
      KONG_CLUSTER_CERT: /certs/cluster.crt
      KONG_CLUSTER_CERT_KEY: /certs/cluster.key
      
      # Database Configuration (DB-less for Data Plane)
      KONG_DATABASE: "off"
      
      # Cluster Configuration
      KONG_CLUSTER_CONTROL_PLANE: kong-cp:8005
      KONG_CLUSTER_TELEMETRY_ENDPOINT: kong-cp:8006
      
      # Proxy Configuration
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_PROXY_LISTEN_SSL: 0.0.0.0:8443
      
      # Logging
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
    ports:
      - "8000:8000"  # Proxy
      - "8443:8443"  # Proxy SSL
    volumes:
      - kong-cluster-certs:/certs:ro
    networks:
      - kong-net-hybrid
    depends_on:
      kong-cp:
        condition: service_healthy
      kong-cert-generator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: on-failure

  # Kong Data Plane 2
  kong-dp-2:
    image: kong:3.4
    container_name: kong-dp-2
    environment:
      # Role Configuration
      KONG_ROLE: data_plane
      KONG_CLUSTER_CERT: /certs/cluster.crt
      KONG_CLUSTER_CERT_KEY: /certs/cluster.key
      
      # Database Configuration (DB-less for Data Plane)
      KONG_DATABASE: "off"
      
      # Cluster Configuration
      KONG_CLUSTER_CONTROL_PLANE: kong-cp:8005
      KONG_CLUSTER_TELEMETRY_ENDPOINT: kong-cp:8006
      
      # Proxy Configuration
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_PROXY_LISTEN_SSL: 0.0.0.0:8443
      
      # Logging
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
    ports:
      - "8100:8000"  # Proxy (different host port to avoid conflict)
      - "8543:8443"  # Proxy SSL (different host port to avoid conflict)
    volumes:
      - kong-cluster-certs:/certs:ro
    networks:
      - kong-net-hybrid
    depends_on:
      kong-cp:
        condition: service_healthy
      kong-cert-generator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: on-failure

  # Certificate Generator for Hybrid Mode
  kong-cert-generator:
    image: kong:3.4
    container_name: kong-cert-generator
    user: root
    command: >
      sh -c "
      if [ ! -f /certs/cluster.crt ]; then
        echo 'Generating cluster certificates...';
        kong hybrid gen_cert /tmp/cluster.crt /tmp/cluster.key;
        cp /tmp/cluster.crt /certs/cluster.crt;
        cp /tmp/cluster.key /certs/cluster.key;
        chmod 644 /certs/cluster.crt;
        chmod 644 /certs/cluster.key;
        chown 1000:1000 /certs/cluster.crt /certs/cluster.key;
        echo 'Certificates generated successfully';
      else
        echo 'Certificates already exist, skipping generation';
      fi
      "
    volumes:
      - kong-cluster-certs:/certs
    networks:
      - kong-net-hybrid

networks:
  kong-net-hybrid:
    driver: bridge

volumes:
  kong-data-cp:
  kong-cluster-certs:
